<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title></title>
		<link rel="stylesheet" type="text/css" href="../css/Hui.css" />
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<style type="text/css">
			.mui-bar {
				-webkit-box-shadow: 1px 0px 3px rgba(0,0,0,0.7);
				box-shadow: 1px 0px 3px rgba(0,0,0,0.7);
			}
			.H-display-block a {
				color: #ccc
			}
			.mui-table-view-cell a {
				color: #333
			}
		</style>
		<script id="msglistTpl" type="text/x-dot-template">
			{{~it:value:index}}
			<div class="list" style="padding-top: 10px" tapmode onclick="">
			<div class="bbs-item H-border-vertical-bottom-after">
			<div class="H-flexbox-horizontal H-theme-background-color-white">
			<div class="H-padding-vertical-both-8" data-id="{{=value.id}}" data-name="{{=value.username}}" data-img="{{=value.userimg}}" tapmode onclick="event.stopPropagation();opengerenzhuye(this);">
			<img src="../image/ad1.png" alt=""  {{? value.userimg}} data-echo="{{=value.userimg}}" {{? }} class=" H-display-block H-margin-horizontal-left-10 H-border-radius-circle H-width-45 H-height-45" />
			</div>
			<div class="H-flex-item H-margin-10">
			<div class="H-theme-font-color-999 H-font-size-14 H-flexbox-horizontal H-text-horizontal-left H-box-sizing-border-box">
			<span class="H-display-block H-flex-item H-text-align-left H-font-size-16" style="color:#333">{{=value.username}}</span>
			<span class="H-display-block H-flex-item H-text-align-right  H-font-size-12 mui-icon mui-icon-star" tapmode onclick="shoucang()"></a></span>
			</div>
			<div class="H-theme-font-color-999 H-text-show-row-1 H-font-size-12">
			{{=_formatDate(value.updatedAt)}}
			</div>
			</div>
			</div>
			<div class="H-theme-background-color-white H-theme-font-color-333  H-font-size-16" style="padding: 2px 10px 10px 10px" onclick="">
			{{=value.neirong}}
			</div>
			{{  if(value.tupian) { }}
			<div id="{{=value.id}}" class="H-theme-background-color-white H-clear-both H-width-100-percent H-display-table H-box-sizing-border-box H-padding-horizontal-left-10 H-padding-horizontal-right-5" onclick="">
			{{ for(var k in value.tupian) { }}
			<li class="H-display-table-cell H-float-left  H-box-sizing-border-box H-width-avg-3 H-padding-horizontal-right-5 H-margin-vertical-bottom-5" data-key="{{=k}}" tapmode onclick="event.stopPropagation();imageBrowsertupian(this)">
			<img  src="../image/zhanweitupian.jpg"   class="H-width-100-percent  H-display-block tupaingaodu" data-tupianurl="{{=value.tupian[k]}}" alt=""  data-echo="{{=value.tupian[k]+"?imageView2/1/w/400/h/400/q/100"}}"/>
			</li>
			{{ }  }}
			</div>
			{{ }  }}
			<div class="H-flexbox-horizontal H-clear-both H-theme-background-color-white H-padding-8 H-box-sizing-border-box H-border-vertical-top-margin-both-10-after">
			<span class="H-font-size-14 H-flex-item  H-center-all H-border-horizontal-right-after"><i class="mui-icon mui-icon-eye  H-theme-font-color-ccc H-font-size-18 H-margin-horizontal-right-5"></i><label class="H-display-inline-block H-vertical-middle">3</label></span>
			<span class="H-font-size-14 H-flex-item  H-center-all"><i class="mui-icon mui-icon-chatbubble H-theme-font-color-ccc H-font-size-18 H-margin-horizontal-right-5"></i><label class="H-display-inline-block H-theme-font-color-ccc H-vertical-middle">3</label></span>
			<span class="H-font-size-14 H-flex-item  H-center-all  H-border-horizontal-left-after"><i class="H-iconfont H-icon-ding-null H-theme-font-color-ccc H-font-size-18 H-margin-horizontal-right-5"></i><label class="H-display-inline-block H-theme-font-color-ccc H-vertical-middle">3</label></span>
			</div>
			</div>
			</div>
			{{~}}
		</script>
		<script id="pinglunlistTpl" type="text/x-dot-template">
			{{~it:value:index}}
			<div class="H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-after H-clear-both" tapmade onclick="pingluntaren('{{=value.username}}','{{=value.neirong}}');">
			<div class="H-padding-vertical-both-8">
			<img  src="../image/zhanweitupian.jpg"  alt="" {{? value.userimg}} data-echo="{{=value.userimg}}" {{? }} class="imgCache H-display-block H-margin-horizontal-left-10 H-border-radius-circle" style="width: 30px; height: 30px;" />
			</div>
			<div class="H-flex-item H-margin-vertical-both-8 H-margin-10">
			<div class="H-theme-font-color-999 H-flexbox-horizontal H-text-horizontal-left H-box-sizing-border-box">
			<span class="H-display-block H-flex-item H-text-align-left H-font-size-15 H-theme-font-color1" style="color:#333">{{=value.username}}</span>
			<span class="H-display-block H-flex-item H-text-align-right H-theme-font-color-999 H-font-size-12">{{=_formatDate(value.updatedAt)}}</span>
			</div>
			<div class="H-font-size-14 H-margin-vertical-top-5 H-font-size-12">
			<div>
			{{=_transEmo(value.neirong)}}
			</div>
			{{ if (value.duixiangname)  { }}
			<div class="H-padding-5 H-margin-vertical-both-5 H-border-radius-3 H-theme-background-color-eee">
			<span class="H-theme-font-color1">{{=value.duixiangname}}：</span>
			{{=_transEmo(value.duixiangneirong)}}
			</div>
			{{  } }}
			</div>
			</div>
			</div>
			{{~}}
		</script>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav" id="aui-header" style="height: 1px;"></header>
		<div class="mui-content" style="padding-top: 0px;margin-top: 0" id="msglist"></div>
		<div class="mui-content" style="padding-top: 10px;margin-top: 0px" id="pinglunlist"></div>
		<div class="H-padding-vertical-bottom-10"></div>
		<script type="text/javascript" src="../script/winu-base.js"></script>
		<script type="text/javascript" src="../script/mui.min.js"></script>
		<script type="text/javascript" src="../script/echo.js"></script>
		<script type="text/javascript" src="../script/api.js"></script>
		<script type="text/javascript" src="../script/SHA1.js"></script>
		<script type="text/javascript" src="../script/doT.min.js"></script>
		<script type="text/javascript" src="../script/zepto.min.js"></script>
		<script type="text/javascript" src="../script/emo.js"></script>
		<script type="text/javascript">
			var imageBrowser;
			var shoujikuandu;
			var shoujigaodu;
			var tupiangaodu
			var browerImgs = [];
			//				Zepto(function($) {
			//					// 绑定会话点击事件
			//					$("#msglist").on("click", "li img", function() {
			////						alert(typeof($(this).parent("div").attr("data-tupian").split(",")));
			//						alert(typeof(JSON.stringify("[\""+$(name).parent("div").attr("data-tupian").replace(/,http/g,"\",\"http")+"\"]")));
			//						//获取用户表自增ID
			////						imageBrowser($(this).attr("data-key"), $(this).attr("data-tupian"));
			//					});
			//				});
			function shoucang(){
			api.toast({
								msg : '收藏成功',
								duration : 1000,
								location : 'middle'
							});
			
			}
			function imageBrowsertupian(name) {
				var browerImgs = [];
				$(name).parent("div").children("li").each(function() {
					// 将图片追加到数组中
					browerImgs.push($(this).find("img").attr("data-tupianurl"));
				});
				//					alert( typeof (browerImgs));
				//				alert("[\""+$(name).parent("div").attr("data-tupian").replace(/,http/g,"\",\"http")+"\"]");
				imageBrowser.openImages({
					imageUrls : browerImgs,
					showList : false,
					activeIndex : $(name).attr("data-key")
				});
			}
//			function imageBrowsertupian(name) {
//				var browerImgs = [];
//				$(name).parent("div").children("li").each(function() {
//					// 将图片追加到数组中
//					browerImgs.push($(this).find("img").attr("data-tupianurl") + "?imageView2/4/w/" + shoujikuandu + "/h/" + shoujigaodu + "/interlace/1/q/100");
//				});
//				//					alert( typeof (browerImgs));
//				//				alert("[\""+$(name).parent("div").attr("data-tupian").replace(/,http/g,"\",\"http")+"\"]");
//				imageBrowser.openImages({
//					imageUrls : browerImgs,
//					showList : false,
//					activeIndex : $(name).attr("data-key")
//				});
//			}

			//			function ceshi() {
			//				mui('.mui-popover').popover('hide');
			//			}
			function openxiangqing(value) {
				api.openWin({
					pageParam : {
						value : value
					},
					name : 'xiangqing-win',
					url : '../html/xiangqing-win.html'
				});
			}
			function pingluntaren(name,neirong){
			
			_sendEvent("sendpinglun", {
									name : name,
									neirong : neirong,
									
								});
			
			
			
			}
			function opengerenzhuye(user) {
				api.openWin({
					pageParam : {
						id : $(user).attr("data-id"),
						name : $(user).attr("data-name"),
						img : $(user).attr("data-img"),
					},
					name : 'zhuyewin',
					url : '../html/zhuyewin.html'
				});
			}

			function scene() {
				var dialogBox = api.require('dialogBox');
				dialogBox.scene({
					rect : {
						w : 280,
						h : 400
					},
					texts : {
						okBtnTitle : '取消'
					},
					styles : {
						bg : '#fff',
						title : {
							bg : '#fff',
							h : 1,
							size : 14,
							color : '#000'
						},
						cell : {
							bg : '#fff',
							h : 48,
							text : {
								color : '#333',
								size : 17
							},
						},
					},
					optionDatas : [{
						text : '收藏'
					}, {
						text : '关注TA'
					}, {
						text : '关注该分类'
					}, {
						text : '屏蔽TA'
					}, {
						text : '屏蔽该分类'
					}, {
						text : '举报'
					}, {
						text : '取消'
					}]
				}, function(ret, err) {
					if (ret) {
						alert(JSON.stringify(ret));
						var dialogBox = api.require('dialogBox');
						dialogBox.close({
							dialogName : 'scene'
						});
					} else {
						alert(JSON.stringify(err));
						var dialogBox = api.require('dialogBox');
						dialogBox.close({
							dialogName : 'scene'
						});
					}
				});
			}

			//				function OpenBbs(id) {
			//					H.openWin('info_head', 'info_head.html', {
			//						'id' : id
			//					});
			//				}
			apiready = function() {
				imageBrowser = api.require('imageBrowser');
				_addEventListener("sendpinglunsuccessed", function(ret) {
				if (ret && ret.value.retshuju) {
					var array=[];
					array.push(ret.value.retshuju);
					var interText = doT.template($("#pinglunlistTpl").text());
						$("#pinglunlist").prepend(interText(array));
						echo.init({
							offset : 100,
							throttle : 250,
							callback : function(element, op) {
							}
						});
					
				}
				document.getElementById('pinglunlist').scrollIntoView();
			});
				var bodyParam = {
					where : {
						"id" : api.pageParam.value
					}
				};
				$api.ajax('/fabu?filter=' + JSON.stringify(bodyParam), 'get', null, function(ret, err) {
					if (ret) {
					
					
						var interText = doT.template($("#msglistTpl").text());
						$("#msglist").prepend(interText(ret));
						echo.init({
							offset : 100,
							throttle : 250,
							callback : function(element, op) {
							}
						});
					}
				})
				getpinglun();
				api.parseTapmode();
				//				getdate();
				api.setRefreshHeaderInfo({
					visible : true,
					loadingImg : 'widget://image/refresh.png',
					bgColor : '#fff',
					textColor : '#ccc',
					textDown : '下拉刷新...',
					textUp : '松开刷新...',
					showTime : true
				}, function(ret, err) {
					//				setTimeout(function() {
					//					getdate();
					api.refreshHeaderLoadDone()
					//				}, 3000);
				});
			}
			function getpinglun() {
				
				$api.ajax('/fabu/' + api.pageParam.value + '/pinglun', 'get', null, function(ret, err) {
					if (ret) {
//						alert(JSON.stringify(ret));
						var interTextpinglun = doT.template($("#pinglunlistTpl").text());
						$("#pinglunlist").prepend(interTextpinglun(ret));
						echo.init({
							offset : 100,
							throttle : 250,
							callback : function(element, op) {
							}
						});
						api.parseTapmode();
					}
				});
			}

			function getdate() {
				var bodyParam = {
					'fields' : {
						'username' : true,
						'id' : true,
						'userimg' : true,
						'imToken' : true,
					},
				};
				$api.ajax('/fabu/', 'get', null, function(ret, err) {
					if (ret) {
						//							alert(JSON.stringify(ret[0]));
						//							alert(JSON.stringify(ret[0].tupian));
						var interText = doT.template($("#msglistTpl").text());
						$("#msglist").prepend(interText(ret));
						echo.init({
							offset : 100,
							throttle : 250,
							callback : function(element, op) {
							}
						});
						api.parseTapmode();
					}
				})
			}
		</script>
	</body>
</html>